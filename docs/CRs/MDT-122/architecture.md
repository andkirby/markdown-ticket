# Architecture: MDT-122

**Source**: [MDT-122](../MDT-122-fix-37-eslint-no-console-violations-in-server.md)
**Generated**: 2026-02-07
**Mode**: Feature Enhancement

## Overview

Introduces a lightweight structured logger (`shared/utils/server-logger.ts`) that uses `console.error()` for debug/info levels — which ESLint already allows — eliminating the need for config exceptions while providing production-ready log levels.

**Key insight**: Rather than adding ESLint exceptions, we use the methods that are already permitted (`console.error`, `console.warn`) with level prefixes for structure.

## Pattern

**Level-Based Logger** — provides debug, info, warn, error methods with runtime filtering, following 2025 Node.js logging best practices without external dependencies.

## Key Dependencies

| Capability | Decision | Rationale |
|------------|----------|-----------|
| Structured logging | Build custom (`server-logger.ts`) | ESLint-compliant, no deps, migration path to Winston/Pino |
| Log levels | Custom enum (debug=0, info=1, warn=2, error=3) | Standard levels, filterable at runtime |

## Structure

```
shared/
  └── utils/
      ├── logger.ts          # Existing: logQuiet, createQuietLogger
      └── server-logger.ts   # NEW: logger with levels (debug, info, warn, error)

server/
  ├── server.ts              # MODIFY: Import logger, replace 29 console.log calls
  └── routes/
      ├── sse.ts             # MODIFY: Import logger, replace 3 console.log calls
      └── system.ts          # MODIFY: Import logger, replace 5 console.log calls
```

## Module Boundaries

| Module | Owns | Must Not |
|--------|------|----------|
| `shared/utils/server-logger.ts` | Logger implementation, level state, console output | No business logic, no file I/O |
| `server/*.ts` | Choosing appropriate log levels for their context | No direct console.log (must use logger) |

## Runtime Prerequisites

| Dependency | Type | Required | When Absent |
|------------|------|----------|-------------|
| `logger.setLevel(level)` | API call | No | Defaults to `info` level if never called |

## Error Philosophy

The logger does not throw. Invalid log levels are ignored silently. Logger failures (e.g., console unavailable) fall through to native console behavior.

**Silent failure**: If `console.error` is unavailable (rare), calls are no-ops rather than throwing.

## Extension Rule

To add structured logging to a new module:
1. Import `import { logger } from '@mdt/shared/utils/server-logger'`
2. Replace `console.log(...)` with appropriate level (`logger.info`, `logger.debug`, etc.)
3. Use `logger.setLevel('warn')` in production bootstrap to reduce noise

**Migration to Winston/Pino**: Replace the `logger` object implementation while keeping the same API (debug, info, warn, error, setLevel). All call sites remain unchanged.

## Implementation Notes

### Log Level Mapping

| Current Usage | New Level | Example |
|---------------|-----------|---------|
| Server startup ("Starting server on port 3001") | `logger.info()` | Operational lifecycle events |
| SSE client ("Client connected") | `logger.info()` | Connection lifecycle |
| Devtools debugging ("Checking path") | `logger.debug()` | Diagnostic information |
| Cache operations ("Cache cleared") | `logger.info()` | State changes |
| Errors | `logger.error()` (already used) | Error conditions |

### Build Requirement

After creating `server-logger.ts`, run `npm run build:shared` before server code can import it.

### ESLint Compliance

The logger uses `console.error()` for `debug` and `info` levels, which `@antfu/eslint-config` already permits. No ESLint config changes needed.

---
*Generated by /mdt:architecture*
