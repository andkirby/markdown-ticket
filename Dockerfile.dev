# Development Dockerfile with hot reload support
FROM node:20-alpine AS base

WORKDIR /app

# Install basic dependencies for development
RUN apk add --no-cache git bash

# Base development environment
FROM base AS dev-base

# Copy package files
COPY package*.json ./
COPY server/package*.json ./server/
COPY mcp-server/package*.json ./mcp-server/
COPY server/mcp-dev-tools/package*.json ./server/mcp-dev-tools/

# Install all dependencies (including dev dependencies)
RUN npm ci
RUN cd server && npm ci
RUN cd mcp-server && npm ci
RUN cd server/mcp-dev-tools && npm ci

# Frontend development target
FROM dev-base AS frontend
COPY . .
EXPOSE 5173
CMD ["npm", "run", "dev"]

# Backend development target
FROM dev-base AS backend
COPY . .
EXPOSE 3001
CMD ["npm", "run", "dev:server"]

# MCP server development target
FROM dev-base AS mcp
COPY . .
CMD ["sh", "-c", "cd mcp-server && npm run dev"]

# Full development environment (default)
FROM dev-base AS development
COPY . .
EXPOSE 5173 3001

# Create directories for data
RUN mkdir -p /app/docs/CRs
RUN mkdir -p /app/data

# Default command for full development
CMD ["npm", "run", "dev:full"]