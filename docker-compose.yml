services:
  # Shared Builder - Builds shared TypeScript modules once
  shared-builder:
    build:
      context: .
      dockerfile: Dockerfile.shared
      target: builder
    image: markdown-ticket-shared-builder:latest
    command: "true"  # No-op command, just build and exit
    profiles:
      - dev
      - frontend
      - backend
      - mcp
      - prod
      - test

  # Config Initializer - Sets up global configuration once before other services
  config-init:
    build:
      context: .
      dockerfile: Dockerfile
      target: base
    environment:
      - MDT_CONFIG_DIR=/config/markdown-ticket
    volumes:
      - user_config:/config  # Mount user_config volume to /config
      - ./config-templates:/app/config-templates:ro  # Read-only config templates
      - ./scripts:/app/scripts:ro  # Read-only scripts
    command: ["./scripts/init-config.sh"]
    restart: "no"  # Run once, don't restart
    profiles:
      - dev
      - frontend
      - backend
      - mcp
      - prod
      - test

  # Frontend - React + Vite
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=http://backend:3001
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - .:/app  # Source code for development hot reload
      - /app/node_modules
    stdin_open: true
    tty: true
    depends_on:
      shared-builder:
        condition: service_completed_successfully
    profiles:
      - dev
      - frontend

  # Backend API - Express.js
  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: development
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - ./server:/app  # Backend source code for hot reload
      - /app/node_modules
      - /app/shared-dist  # Preserve shared-dist from build
      - user_config:/root/.config  # Global configuration
      - project_data:/app/data  # Project data persistence
      - ./server/sample-projects:/app/sample-projects  # Sample projects for registry access
      - ./projects:/app/projects  # User projects directory
      - ./.mdt-config.toml:/app/project-root/.mdt-config.toml:ro  # Project root config for discovery
    depends_on:
      shared-builder:
        condition: service_completed_successfully
      config-init:
        condition: service_completed_successfully
    profiles:
      - dev
      - backend

  # MCP Server - Model Context Protocol
  mcp-server:
    build:
      context: .
      dockerfile: mcp-server/Dockerfile
      target: development
    environment:
      - NODE_ENV=development
      - MCP_PROJECT_FILTER=${MCP_PROJECT_FILTER:-}
    volumes:
      - ./mcp-server:/app  # MCP server source code
      - /app/node_modules
      - /app/shared-dist  # Preserve shared-dist from build
      - user_config:/root/.config  # Global configuration
      - project_data:/app/data  # Project data persistence
      - ./server/sample-projects:/app/sample-projects  # Sample projects for auto-discovery
      - ./.mdt-config.toml:/app/project-root/.mdt-config.toml:ro  # Project root config for discovery
    depends_on:
      shared-builder:
        condition: service_completed_successfully
      config-init:
        condition: service_completed_successfully
    profiles:
      - dev
      - mcp

  # MCP Dev Tools - Logging and Debugging
  mcp-dev-tools:
    build:
      context: .
      dockerfile: server/mcp-dev-tools/Dockerfile
      target: development
    environment:
      - NODE_ENV=development
    volumes:
      - ./server/mcp-dev-tools:/app  # Dev tools source code
      - /app/node_modules
      - /app/shared-dist  # Preserve shared-dist from build
      - user_config:/root/.config  # Global configuration for logging
    depends_on:
      shared-builder:
        condition: service_completed_successfully
    profiles:
      - dev
      - mcp-dev

  # Production Frontend
  frontend-prod:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=production
    profiles:
      - prod

  # Production Backend
  backend-prod:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: production
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
    volumes:
      - user_config:/root/.config  # Global configuration
      - project_data:/app/data  # Project data persistence
    depends_on:
      config-init:
        condition: service_completed_successfully
    profiles:
      - prod

  # Production MCP Server
  mcp-server-prod:
    build:
      context: .
      dockerfile: mcp-server/Dockerfile
      target: production
    environment:
      - NODE_ENV=production
      - MCP_PROJECT_FILTER=${MCP_PROJECT_FILTER:-}
    volumes:
      - user_config:/root/.config  # Global configuration
      - project_data:/app/data  # Project data access
    depends_on:
      config-init:
        condition: service_completed_successfully
    profiles:
      - prod

  # Production MCP Dev Tools
  mcp-dev-tools-prod:
    build:
      context: .
      dockerfile: server/mcp-dev-tools/Dockerfile
      target: production
    environment:
      - NODE_ENV=production
    volumes:
      - user_config:/root/.config  # Global configuration
    profiles:
      - prod

  # E2E Testing
  test:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - VITE_API_BASE_URL=http://backend:3001
    command: npm run test:e2e
    profiles:
      - test
    depends_on:
      - frontend
      - backend

# Shared volumes for configuration and project data
volumes:
  # User configuration persistence
  user_config:
    driver: local
  # Project data persistence
  project_data:
    driver: local